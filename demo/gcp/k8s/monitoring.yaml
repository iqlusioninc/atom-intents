apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: skip-select
  namespace: atom-intents
  labels:
    app.kubernetes.io/name: skip-select-simulator
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: skip-select-simulator
  endpoints:
    - port: metrics
      interval: 15s
      path: /metrics

---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: skip-select-alerts
  namespace: atom-intents
  labels:
    app.kubernetes.io/name: skip-select-simulator
spec:
  groups:
    - name: skip-select
      rules:
        # High error rate
        - alert: SkipSelectHighErrorRate
          expr: |
            sum(rate(http_requests_total{service="skip-select",status=~"5.."}[5m]))
            / sum(rate(http_requests_total{service="skip-select"}[5m])) > 0.05
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High error rate in Skip Select Simulator"
            description: "Error rate is above 5% for the last 5 minutes"

        # High latency
        - alert: SkipSelectHighLatency
          expr: |
            histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="skip-select"}[5m])) by (le))
            > 2
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High latency in Skip Select Simulator"
            description: "95th percentile latency is above 2 seconds"

        # Pod not ready
        - alert: SkipSelectPodNotReady
          expr: |
            kube_pod_status_ready{namespace="atom-intents",pod=~"skip-select.*"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Skip Select pod is not ready"
            description: "Pod {{ $labels.pod }} has been not ready for 5 minutes"

        # Low replica count
        - alert: SkipSelectLowReplicas
          expr: |
            kube_deployment_status_replicas_available{namespace="atom-intents",deployment="skip-select"} < 2
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Skip Select has low replica count"
            description: "Available replicas dropped below 2"

        # Auction processing time
        - alert: SkipSelectSlowAuctions
          expr: |
            histogram_quantile(0.95, sum(rate(auction_processing_duration_seconds_bucket[5m])) by (le)) > 1
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Slow auction processing"
            description: "95th percentile auction processing time is above 1 second"

        # Settlement failures
        - alert: SkipSelectSettlementFailures
          expr: |
            sum(rate(settlements_total{status="failed"}[15m])) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Settlement failures detected"
            description: "One or more settlements have failed in the last 15 minutes"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-skip-select
  namespace: atom-intents
  labels:
    grafana_dashboard: "1"
data:
  skip-select-dashboard.json: |
    {
      "annotations": {
        "list": []
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "title": "Request Rate",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
          "targets": [
            {
              "expr": "sum(rate(http_requests_total{service=\"skip-select\"}[5m])) by (method, path)",
              "legendFormat": "{{method}} {{path}}"
            }
          ]
        },
        {
          "title": "Error Rate",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
          "targets": [
            {
              "expr": "sum(rate(http_requests_total{service=\"skip-select\",status=~\"5..\"}[5m])) / sum(rate(http_requests_total{service=\"skip-select\"}[5m])) * 100",
              "legendFormat": "Error %"
            }
          ]
        },
        {
          "title": "Latency (p95)",
          "type": "timeseries",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service=\"skip-select\"}[5m])) by (le))",
              "legendFormat": "p95"
            }
          ]
        },
        {
          "title": "Active Intents",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 12, "y": 8},
          "targets": [
            {
              "expr": "skip_select_pending_intents",
              "legendFormat": "Pending"
            }
          ]
        },
        {
          "title": "Active Solvers",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 18, "y": 8},
          "targets": [
            {
              "expr": "skip_select_active_solvers",
              "legendFormat": "Active"
            }
          ]
        },
        {
          "title": "Auctions/min",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 12, "y": 12},
          "targets": [
            {
              "expr": "sum(rate(auctions_total[1m])) * 60",
              "legendFormat": "Auctions"
            }
          ]
        },
        {
          "title": "Settlements/min",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 18, "y": 12},
          "targets": [
            {
              "expr": "sum(rate(settlements_total{status=\"completed\"}[1m])) * 60",
              "legendFormat": "Completed"
            }
          ]
        }
      ],
      "refresh": "10s",
      "schemaVersion": 38,
      "style": "dark",
      "tags": ["atom-intents", "skip-select"],
      "templating": {"list": []},
      "time": {"from": "now-1h", "to": "now"},
      "timepicker": {},
      "timezone": "",
      "title": "Skip Select Simulator",
      "version": 1
    }
