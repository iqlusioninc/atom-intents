# Prometheus Operator CRDs (optional - requires Prometheus Operator to be installed)
# These resources will be skipped if the CRDs are not available
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: skip-select
  namespace: atom-intents
  labels:
    app.kubernetes.io/name: skip-select-simulator
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: skip-select-simulator
  endpoints:
    - port: metrics
      interval: 15s
      path: /metrics

---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: skip-select-alerts
  namespace: atom-intents
  labels:
    app.kubernetes.io/name: skip-select-simulator
spec:
  groups:
    - name: skip-select
      rules:
        # High error rate
        - alert: SkipSelectHighErrorRate
          expr: |
            sum(rate(http_requests_total{service="skip-select",status=~"5.."}[5m]))
            / sum(rate(http_requests_total{service="skip-select"}[5m])) > 0.05
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High error rate in Skip Select Simulator"
            description: "Error rate is above 5% for the last 5 minutes"

        # High latency
        - alert: SkipSelectHighLatency
          expr: |
            histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{service="skip-select"}[5m])) by (le))
            > 2
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High latency in Skip Select Simulator"
            description: "95th percentile latency is above 2 seconds"

        # Pod not ready
        - alert: SkipSelectPodNotReady
          expr: |
            kube_pod_status_ready{namespace="atom-intents",pod=~"skip-select.*"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Skip Select pod is not ready"
            description: "Pod {{ $labels.pod }} has been not ready for 5 minutes"

        # Low replica count
        - alert: SkipSelectLowReplicas
          expr: |
            kube_deployment_status_replicas_available{namespace="atom-intents",deployment="skip-select"} < 2
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Skip Select has low replica count"
            description: "Available replicas dropped below 2"

        # Auction processing time
        - alert: SkipSelectSlowAuctions
          expr: |
            histogram_quantile(0.95, sum(rate(auction_processing_duration_seconds_bucket[5m])) by (le)) > 1
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Slow auction processing"
            description: "95th percentile auction processing time is above 1 second"

        # Settlement failures
        - alert: SkipSelectSettlementFailures
          expr: |
            sum(rate(settlements_total{status="failed"}[15m])) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Settlement failures detected"
            description: "One or more settlements have failed in the last 15 minutes"

        # Server wallet low balance - critical for demo operations
        - alert: ServerWalletLowBalance
          expr: |
            server_wallet_balance_uatom < 1000000
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Server wallet balance critically low"
            description: "Server wallet has less than 1 ATOM. Settlements will fail. Fund the wallet immediately."

        # Server wallet warning threshold
        - alert: ServerWalletBalanceWarning
          expr: |
            server_wallet_balance_uatom < 10000000
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Server wallet balance low"
            description: "Server wallet has less than 10 ATOM. Consider funding the wallet soon."

        # Chain health degraded
        - alert: ChainHealthDegraded
          expr: |
            chain_health_status == 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Chain health check failing"
            description: "Chain {{ $labels.chain_id }} health check has been failing for 5 minutes"
